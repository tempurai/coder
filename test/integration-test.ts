#!/usr/bin/env node\n\n/**\n * Coder AI CLI åŠŸèƒ½æµ‹è¯•è„šæœ¬\n * ç”¨äºéªŒè¯æ‰€æœ‰æ–°åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport { ConfigLoader, Config } from '../src/config/ConfigLoader';\nimport { SimpleAgent } from '../src/agents/SimpleAgent';\nimport { checkpointManager } from '../src/tools/CheckpointManager';\nimport { diffDisplay } from '../src/tools/EnhancedDiffDisplay';\n\n// æµ‹è¯•é¢œè‰²è¾“å‡º\nconst colors = {\n    green: '\\x1b[32m',\n    red: '\\x1b[31m',\n    yellow: '\\x1b[33m',\n    cyan: '\\x1b[36m',\n    reset: '\\x1b[0m',\n    bold: '\\x1b[1m'\n};\n\nfunction log(message: string, color: string = colors.reset) {\n    console.log(`${color}${message}${colors.reset}`);\n}\n\nfunction logTest(testName: string, status: 'PASS' | 'FAIL' | 'SKIP', details?: string) {\n    const statusColor = status === 'PASS' ? colors.green : status === 'FAIL' ? colors.red : colors.yellow;\n    const statusIcon = status === 'PASS' ? 'âœ…' : status === 'FAIL' ? 'âŒ' : 'âš ï¸';\n    \n    console.log(`${statusIcon} ${colors.bold}${testName}${colors.reset} - ${statusColor}${status}${colors.reset}`);\n    if (details) {\n        console.log(`   ${colors.cyan}${details}${colors.reset}`);\n    }\n}\n\n// æµ‹è¯•å¥—ä»¶\nclass TestSuite {\n    private passedTests = 0;\n    private failedTests = 0;\n    private skippedTests = 0;\n    \n    async runAllTests() {\n        log('\\nğŸš€ å¼€å§‹ Coder AI CLI åŠŸèƒ½æµ‹è¯•', colors.bold + colors.cyan);\n        log('â”'.repeat(60), colors.cyan);\n        \n        await this.testConfigSystem();\n        await this.testDiffDisplay();\n        await this.testCheckpointSystem();\n        await this.testAgentIntegration();\n        \n        this.displaySummary();\n    }\n    \n    async testConfigSystem() {\n        log('\\nğŸ“‹ æµ‹è¯•é…ç½®ç³»ç»Ÿ', colors.yellow);\n        \n        try {\n            // æµ‹è¯•é…ç½®åŠ è½½\n            const configLoader = ConfigLoader.getInstance();\n            const config = configLoader.getConfig();\n            \n            if (config.model && config.temperature !== undefined) {\n                logTest('é…ç½®åŠ è½½', 'PASS', `æ¨¡å‹: ${config.model}, æ¸©åº¦: ${config.temperature}`);\n                this.passedTests++;\n            } else {\n                logTest('é…ç½®åŠ è½½', 'FAIL', 'é…ç½®å¯¹è±¡ç¼ºå°‘å¿…éœ€å­—æ®µ');\n                this.failedTests++;\n            }\n            \n            // æµ‹è¯•é…ç½®æ–‡ä»¶è·¯å¾„\n            const configPath = configLoader.getConfigPath();\n            if (configPath.includes('.coder-ai')) {\n                logTest('é…ç½®è·¯å¾„', 'PASS', `è·¯å¾„: ${configPath}`);\n                this.passedTests++;\n            } else {\n                logTest('é…ç½®è·¯å¾„', 'FAIL', 'é…ç½®è·¯å¾„ä¸æ­£ç¡®');\n                this.failedTests++;\n            }\n            \n        } catch (error) {\n            logTest('é…ç½®ç³»ç»Ÿ', 'FAIL', `é”™è¯¯: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);\n            this.failedTests++;\n        }\n    }\n    \n    async testDiffDisplay() {\n        log('\\nğŸ¨ æµ‹è¯•Diffæ˜¾ç¤º', colors.yellow);\n        \n        try {\n            const originalContent = 'function hello() {\\n  console.log(\"Hello World\");\\n}';\n            const modifiedContent = 'function hello() {\\n  console.log(\"Hello, AI World!\");\\n  return true;\\n}';\n            \n            // è¿™é‡Œåªæ˜¯æµ‹è¯•diffæ˜¾ç¤ºå¯¹è±¡æ˜¯å¦å­˜åœ¨å’Œå¯ç”¨\n            if (typeof diffDisplay.displayDiff === 'function') {\n                logTest('Diffæ˜¾ç¤ºæ¨¡å—', 'PASS', 'æ¨¡å—åŠ è½½æˆåŠŸï¼Œæ–¹æ³•å¯ç”¨');\n                this.passedTests++;\n            } else {\n                logTest('Diffæ˜¾ç¤ºæ¨¡å—', 'FAIL', 'displayDiffæ–¹æ³•ä¸å­˜åœ¨');\n                this.failedTests++;\n            }\n            \n            if (typeof diffDisplay.displaySideBySideDiff === 'function') {\n                logTest('å¹¶åˆ—Diffæ˜¾ç¤º', 'PASS', 'å¹¶åˆ—æ˜¾ç¤ºåŠŸèƒ½å¯ç”¨');\n                this.passedTests++;\n            } else {\n                logTest('å¹¶åˆ—Diffæ˜¾ç¤º', 'FAIL', 'å¹¶åˆ—æ˜¾ç¤ºåŠŸèƒ½ä¸å¯ç”¨');\n                this.failedTests++;\n            }\n            \n        } catch (error) {\n            logTest('Diffæ˜¾ç¤º', 'FAIL', `é”™è¯¯: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);\n            this.failedTests++;\n        }\n    }\n    \n    async testCheckpointSystem() {\n        log('\\nğŸ’¾ æµ‹è¯•æ£€æŸ¥ç‚¹ç³»ç»Ÿ', colors.yellow);\n        \n        try {\n            // åˆ›å»ºæµ‹è¯•æ–‡ä»¶\n            const testFile = path.join(__dirname, 'test-file.txt');\n            fs.writeFileSync(testFile, 'This is a test file for checkpoint system.');\n            \n            // æµ‹è¯•æ£€æŸ¥ç‚¹åˆ›å»º\n            const checkpointId = await checkpointManager.createCheckpoint(\n                [testFile],\n                'Test checkpoint creation',\n                'test'\n            );\n            \n            if (checkpointId && checkpointId.startsWith('cp_')) {\n                logTest('æ£€æŸ¥ç‚¹åˆ›å»º', 'PASS', `æ£€æŸ¥ç‚¹ID: ${checkpointId}`);\n                this.passedTests++;\n                \n                // æµ‹è¯•æ£€æŸ¥ç‚¹åˆ—è¡¨\n                const checkpoints = checkpointManager.listCheckpoints();\n                if (checkpoints.length > 0) {\n                    logTest('æ£€æŸ¥ç‚¹åˆ—è¡¨', 'PASS', `æ‰¾åˆ° ${checkpoints.length} ä¸ªæ£€æŸ¥ç‚¹`);\n                    this.passedTests++;\n                } else {\n                    logTest('æ£€æŸ¥ç‚¹åˆ—è¡¨', 'FAIL', 'æ£€æŸ¥ç‚¹åˆ—è¡¨ä¸ºç©º');\n                    this.failedTests++;\n                }\n                \n                // æ¸…ç†æµ‹è¯•æ£€æŸ¥ç‚¹\n                await checkpointManager.deleteCheckpoint(checkpointId);\n                logTest('æ£€æŸ¥ç‚¹æ¸…ç†', 'PASS', 'æµ‹è¯•æ£€æŸ¥ç‚¹å·²åˆ é™¤');\n                this.passedTests++;\n            } else {\n                logTest('æ£€æŸ¥ç‚¹åˆ›å»º', 'FAIL', 'æ£€æŸ¥ç‚¹IDæ ¼å¼ä¸æ­£ç¡®');\n                this.failedTests++;\n            }\n            \n            // æ¸…ç†æµ‹è¯•æ–‡ä»¶\n            fs.unlinkSync(testFile);\n            \n        } catch (error) {\n            logTest('æ£€æŸ¥ç‚¹ç³»ç»Ÿ', 'FAIL', `é”™è¯¯: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);\n            this.failedTests++;\n        }\n    }\n    \n    async testAgentIntegration() {\n        log('\\nğŸ¤– æµ‹è¯•Agenté›†æˆ', colors.yellow);\n        \n        try {\n            const configLoader = ConfigLoader.getInstance();\n            const config = configLoader.getConfig();\n            \n            // æ£€æŸ¥API Key\n            const apiKey = config.apiKey || process.env.OPENAI_API_KEY;\n            if (!apiKey) {\n                logTest('Agentåˆå§‹åŒ–', 'SKIP', 'API Keyæœªè®¾ç½®ï¼Œè·³è¿‡Agentæµ‹è¯•');\n                this.skippedTests++;\n                return;\n            }\n            \n            // åˆ›å»ºAgent\n            const agent = new SimpleAgent(config);\n            \n            if (agent) {\n                logTest('Agentåˆ›å»º', 'PASS', 'æˆåŠŸåˆ›å»ºAgentå®ä¾‹');\n                this.passedTests++;\n            } else {\n                logTest('Agentåˆ›å»º', 'FAIL', 'Agentåˆ›å»ºå¤±è´¥');\n                this.failedTests++;\n                return;\n            }\n            \n            // æµ‹è¯•é…ç½®è·å–\n            const agentConfig = agent.getConfig();\n            if (agentConfig.model === config.model) {\n                logTest('Agenté…ç½®', 'PASS', `é…ç½®æ­£ç¡®åº”ç”¨ï¼Œæ¨¡å‹: ${agentConfig.model}`);\n                this.passedTests++;\n            } else {\n                logTest('Agenté…ç½®', 'FAIL', 'é…ç½®æœªæ­£ç¡®åº”ç”¨');\n                this.failedTests++;\n            }\n            \n            // æµ‹è¯•å¥åº·æ£€æŸ¥ï¼ˆä»…åœ¨æœ‰API Keyæ—¶ï¼‰\n            try {\n                const healthResult = await agent.healthCheck();\n                if (healthResult.status === 'healthy') {\n                    logTest('Agentå¥åº·æ£€æŸ¥', 'PASS', healthResult.message);\n                    this.passedTests++;\n                } else {\n                    logTest('Agentå¥åº·æ£€æŸ¥', 'FAIL', healthResult.message);\n                    this.failedTests++;\n                }\n            } catch (healthError) {\n                logTest('Agentå¥åº·æ£€æŸ¥', 'FAIL', 'å¥åº·æ£€æŸ¥å¼‚å¸¸');\n                this.failedTests++;\n            }\n            \n            // æµ‹è¯•æµå¼è¾“å‡ºæ–¹æ³•å­˜åœ¨æ€§\n            if (typeof agent.processStream === 'function') {\n                logTest('æµå¼è¾“å‡ºæ”¯æŒ', 'PASS', 'processStreamæ–¹æ³•å¯ç”¨');\n                this.passedTests++;\n            } else {\n                logTest('æµå¼è¾“å‡ºæ”¯æŒ', 'FAIL', 'processStreamæ–¹æ³•ä¸å­˜åœ¨');\n                this.failedTests++;\n            }\n            \n        } catch (error) {\n            logTest('Agenté›†æˆ', 'FAIL', `é”™è¯¯: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);\n            this.failedTests++;\n        }\n    }\n    \n    displaySummary() {\n        log('\\nğŸ“Š æµ‹è¯•æ€»ç»“', colors.bold + colors.cyan);\n        log('â”'.repeat(60), colors.cyan);\n        \n        const totalTests = this.passedTests + this.failedTests + this.skippedTests;\n        \n        logTest(`æ€»æµ‹è¯•æ•°: ${totalTests}`, 'PASS');\n        logTest(`é€šè¿‡: ${this.passedTests}`, 'PASS');\n        \n        if (this.failedTests > 0) {\n            logTest(`å¤±è´¥: ${this.failedTests}`, 'FAIL');\n        }\n        \n        if (this.skippedTests > 0) {\n            logTest(`è·³è¿‡: ${this.skippedTests}`, 'SKIP');\n        }\n        \n        const successRate = totalTests > 0 ? ((this.passedTests / totalTests) * 100).toFixed(1) : '0';\n        log(`\\næˆåŠŸç‡: ${successRate}%`, colors.bold);\n        \n        if (this.failedTests === 0) {\n            log('\\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿå‡†å¤‡å°±ç»ªã€‚', colors.green + colors.bold);\n            if (this.skippedTests > 0) {\n                log('ğŸ’¡ æç¤º: è®¾ç½®OPENAI_API_KEYç¯å¢ƒå˜é‡ä»¥è¿è¡Œå®Œæ•´æµ‹è¯•ã€‚', colors.yellow);\n            }\n        } else {\n            log('\\nâš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯ã€‚', colors.red + colors.bold);\n            log('ğŸ”§ å»ºè®®è¿è¡Œ: npm run config:reset', colors.yellow);\n        }\n        \n        log('\\nğŸš€ å¯åŠ¨å¢å¼ºCLI: npm start', colors.cyan);\n        log('ğŸ“– æŸ¥çœ‹ä½¿ç”¨è¯´æ˜: README-ENHANCED.md', colors.cyan);\n    }\n}\n\n// ä¸»å‡½æ•°\nasync function main() {\n    const testSuite = new TestSuite();\n    await testSuite.runAllTests();\n}\n\n// é”™è¯¯å¤„ç†\nprocess.on('unhandledRejection', (reason) => {\n    console.error('\\nâŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);\n    process.exit(1);\n});\n\nprocess.on('uncaughtException', (error) => {\n    console.error('\\nâŒ æœªæ•è·çš„å¼‚å¸¸:', error);\n    process.exit(1);\n});\n\n// è¿è¡Œæµ‹è¯•\nif (require.main === module) {\n    main().catch((error) => {\n        console.error('\\nâŒ æµ‹è¯•æ‰§è¡Œå¤±è´¥:', error);\n        process.exit(1);\n    });\n}